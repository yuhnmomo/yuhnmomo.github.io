<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>《室友戀愛指南》遊戲開場設定</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Rose Gold Color Palette */
        :root {
            --rose-gold-light: #E6C2C2;
            --rose-gold-main: #D9A0A0;
            --rose-gold-dark: #C48A8A;
            --dark-bg: #1a1a1a;
            --dark-card: #2a2a2a;
            --dark-border: #444444;
            --dark-input: #333333;
            --text-light: #EAEAEA;
            --text-muted: #A0A0A0;
            --text-dark: #000000;
        }

        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text-light);
        }
        .step-card {
            background-color: var(--dark-card);
            border: 1px solid var(--dark-border);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .form-input {
            background-color: var(--dark-input);
            border: 2px solid var(--dark-border);
            color: var(--text-light);
            transition: border-color 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--rose-gold-main);
        }
        .form-input.invalid {
            border-color: #F87171;
        }
        .btn-primary {
            background-color: var(--rose-gold-main);
            color: var(--dark-bg);
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: var(--rose-gold-dark);
        }
        .btn-secondary {
            background-color: #4B5563;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #6B7280;
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        
        /* Text Card Radio Button Styles */
        .text-card-label { display: block; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; }
        .text-card-content { background-color: var(--dark-input); border: 2px solid var(--dark-border); border-radius: 0.5rem; padding: 0.75rem 1rem; transition: all 0.2s; text-align: center; height: 100%; display: flex; align-items: center; justify-content: center; }
        .text-card-label:hover .text-card-content { border-color: #6B7280; }
        .text-card-text { color: var(--text-light); transition: color 0.2s ease-in-out; }
        .text-card-label input[type="radio"]:checked + .text-card-content { border-color: var(--rose-gold-dark); background-color: var(--rose-gold-main); }
        .text-card-label input[type="radio"]:checked + .text-card-content .text-card-text { color: var(--text-dark); font-weight: 500; }
        
        /* Card Grid Styles */
        .card-grid {
            display: grid;
            gap: 1rem;
            padding: 4px;
        }
        .appearance-grid {
             grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        }
        .zodiac-grid {
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
        .icon-grid {
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        }
        .text-card-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }

        .card-label { cursor: pointer; }
        .card { background-color: var(--dark-input); border: 2px solid var(--dark-border); border-radius: 0.5rem; overflow: hidden; transition: all 0.2s ease-in-out; position: relative; }
        .card:hover { border-color: var(--rose-gold-main); transform: translateY(-4px); }
        .card img { width: 100%; height: 160px; object-fit: cover; }
        .card-content { padding: 0.75rem; text-align: center; }
        .card-title { font-weight: 600; color: var(--text-light); margin-bottom: 0.5rem; font-size: 0.9rem; }
        .card-desc { font-size: 0.75rem; color: var(--text-muted); line-height: 1.6; }
        .card-label input:checked + .card { border-color: var(--rose-gold-dark); box-shadow: 0 0 15px rgba(217, 160, 160, 0.4); }
        .check-icon { position: absolute; top: 0.5rem; right: 0.5rem; width: 1.5rem; height: 1.5rem; background-color: var(--rose-gold-main); border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transform: scale(0.5); transition: all 0.2s ease-in-out; }
        .card-label input:checked + .card .check-icon { opacity: 1; transform: scale(1); }
        
        .zodiac-emoji { font-size: 3rem; height: 120px; display: flex; align-items: center; justify-content: center; }
        .icon-emoji { font-size: 2.5rem; height: 80px; display: flex; align-items: center; justify-content: center; }

        /* Summary Page Styles */
        .summary-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 640px) { .summary-grid { grid-template-columns: 1fr 1fr; } }
        .summary-card { background-color: var(--dark-input); border-radius: 0.5rem; padding: 1rem; border: 1px solid var(--dark-border); }
        .summary-card img { 
            width: 100%; 
            aspect-ratio: 1 / 1; 
            object-fit: cover; 
            border-radius: 0.25rem; 
            margin-bottom: 1rem; 
        }
        .summary-title { font-size: 1.25rem; font-weight: bold; color: var(--rose-gold-light); margin-bottom: 1rem; }
        .summary-details p { font-size: 0.875rem; margin-bottom: 0.5rem; }
        .summary-details span { color: var(--text-muted); margin-right: 0.5rem; }

    </style>
    <script src="gameData.js"></script>
</head>
<body>

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="flex flex-col md:flex-row md:items-center md:justify-between mb-8 gap-4">
            <div class="w-full md:w-auto order-2 md:order-1">
                 <a href="/roles.html" class="btn-secondary text-white font-bold py-2 px-4 rounded-lg text-sm w-full block text-center md:w-auto">
                    返回角色頁
                </a>
            </div>
            <div class="text-center order-1 md:order-2">
                <h1 class="text-3xl sm:text-4xl font-bold" style="color: var(--rose-gold-light);">《室友戀愛指南》</h1>
                <p style="color: var(--text-muted);" class="mt-2">遊戲開場與角色生成</p>
            </div>
            <div class="hidden md:block order-3" style="width: 120px;"></div>
        </header>

        <main id="game-setup-container">
            <!-- Step 1: Player Info -->
            <div id="step-1" class="step active">
                <div class="step-card rounded-lg p-6 sm:p-8 shadow-lg">
                    <h2 class="text-2xl font-semibold mb-6" style="color: var(--rose-gold-light);">1. 玩家身份設定</h2>
                    <div class="space-y-6">
                        <div>
                            <label class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">性別</label>
                            <div id="playerGender" class="card-grid icon-grid"></div>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">性向</label>
                            <div id="playerSexuality" class="card-grid icon-grid"></div>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">職業</label>
                            <div id="playerProfession" class="card-grid icon-grid"></div>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">星座</label>
                            <div id="playerZodiac" class="card-grid zodiac-grid"></div>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">血型</label>
                            <div id="playerBloodType" class="card-grid icon-grid"></div>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end items-center gap-4">
                        <button onclick="nextStep()" class="btn-primary font-bold py-2 px-6 rounded-lg">下一步</button>
                    </div>
                </div>
            </div>

            <!-- Step 2: Player Appearance -->
            <div id="step-2" class="step">
                <div class="step-card rounded-lg p-6 sm:p-8 shadow-lg">
                    <h2 class="text-2xl font-semibold mb-6" style="color: var(--rose-gold-light);">2. 玩家外觀設定</h2>
                    <div id="playerAppearance" class="card-grid appearance-grid"></div>
                    <div class="mt-8 flex justify-between">
                        <button onclick="prevStep()" class="btn-secondary text-white font-bold py-2 px-6 rounded-lg">返回</button>
                        <button onclick="nextStep()" class="btn-primary font-bold py-2 px-6 rounded-lg">下一步</button>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Roommate Info -->
            <div id="step-3" class="step">
                <div class="step-card rounded-lg p-6 sm:p-8 shadow-lg">
                    <h2 class="text-2xl font-semibold mb-6" style="color: var(--rose-gold-light);">3. 室友訂製</h2>
                    <div class="space-y-6">
                        <div>
                            <label class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">性別</label>
                            <div id="roommateGender" class="card-grid icon-grid"></div>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">職業</label>
                            <div id="roommateProfession" class="card-grid icon-grid"></div>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">星座</label>
                            <div id="roommateZodiac" class="card-grid zodiac-grid"></div>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">血型</label>
                            <div id="roommateBloodType" class="card-grid icon-grid"></div>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-between items-center">
                        <button onclick="prevStep()" class="btn-secondary text-white font-bold py-2 px-6 rounded-lg">返回</button>
                        <button onclick="nextStep()" class="btn-primary font-bold py-2 px-6 rounded-lg">下一步</button>
                    </div>
                </div>
            </div>

            <!-- Step 4: Roommate Appearance -->
            <div id="step-4" class="step">
                <div class="step-card rounded-lg p-6 sm:p-8 shadow-lg">
                    <h2 class="text-2xl font-semibold mb-6" style="color: var(--rose-gold-light);">4. 室友外觀設定</h2>
                    <div id="roommateAppearance" class="card-grid appearance-grid"></div>
                    <div class="mt-8 flex justify-between">
                        <button onclick="prevStep()" class="btn-secondary text-white font-bold py-2 px-6 rounded-lg">返回</button>
                        <button onclick="nextStep()" class="btn-primary font-bold py-2 px-6 rounded-lg">下一步</button>
                    </div>
                </div>
            </div>

            <!-- Step 5: Relationship, Names & Nickname -->
            <div id="step-5" class="step">
                <div class="step-card rounded-lg p-6 sm:p-8 shadow-lg">
                    <h2 class="text-2xl font-semibold mb-6" style="color: var(--rose-gold-light);">5. 關係與命名</h2>
                    <div class="space-y-6">
                        <div>
                            <label class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">初始關係</label>
                            <p class="text-xs mb-2" style="color: var(--text-muted);">在這次合租之前，你和這位即將到來的室友是什麼關係呢？</p>
                            <div id="initialRelationship" class="card-grid text-card-grid"></div>
                        </div>
                        <div>
                            <label class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">親密行為風格</label>
                            <div id="roommateIntimacy" class="card-grid icon-grid"></div>
                        </div>
                        <div>
                            <label for="playerName" class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">你的名字</label>
                            <input type="text" id="playerName" class="form-input w-full rounded-lg p-2.5" placeholder="請輸入姓名" maxlength="6">
                            <p class="text-xs mt-1" style="color: var(--text-muted);">最多6個字</p>
                        </div>
                        <div>
                            <label for="roommateName" class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">室友的名字</label>
                            <input type="text" id="roommateName" class="form-input w-full rounded-lg p-2.5" placeholder="請輸入姓名" maxlength="6">
                             <p class="text-xs mt-1" style="color: var(--text-muted);">最多6個字</p>
                        </div>
                        <div>
                            <label for="roommateNickname" class="block mb-2 text-sm font-medium" style="color: var(--text-muted);">室友對你的稱呼</label>
                            <input type="text" id="roommateNickname" class="form-input w-full rounded-lg p-2.5" placeholder="例如：你的名字、小名等" maxlength="6">
                             <p class="text-xs mt-1" style="color: var(--text-muted);">最多6個字</p>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-between items-center">
                        <button onclick="prevStep()" class="btn-secondary text-white font-bold py-2 px-6 rounded-lg">返回</button>
                        <div class="flex items-center gap-4">
                            <p class="error-message text-red-400 text-sm h-5"></p>
                            <button onclick="showSummary()" class="btn-primary font-bold py-2 px-6 rounded-lg">完成設定</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 6: Summary & Download -->
            <div id="step-6" class="step">
                <div class="step-card rounded-lg p-6 sm:p-8 shadow-lg">
                    <h2 class="text-2xl font-semibold mb-6" style="color: var(--rose-gold-light);">最終確認</h2>
                    <div id="summary-visual" class="summary-grid mb-6">
                        <!-- Visual summary will be injected here -->
                    </div>
                    <h3 class="text-lg font-semibold mb-2" style="color: var(--rose-gold-light);">數據彙總 (出圖用)</h3>
                    <div class="rounded-lg p-4 text-sm leading-relaxed whitespace-pre-wrap" id="summary-output" style="background-color: var(--dark-bg); color: var(--text-light);">
                        <!-- Text summary will be injected here -->
                    </div>
                    <div class="mt-8 flex flex-col sm:flex-row justify-between gap-4">
                        <div class="flex flex-wrap gap-2">
                            <button onclick="goToStep(1)" class="btn-secondary text-white text-sm font-bold py-2 px-4 rounded-lg">修改玩家資料</button>
                            <button onclick="goToStep(2)" class="btn-secondary text-white text-sm font-bold py-2 px-4 rounded-lg">修改玩家外觀</button>
                            <button onclick="goToStep(3)" class="btn-secondary text-white text-sm font-bold py-2 px-4 rounded-lg">修改室友資料</button>
                            <button onclick="goToStep(4)" class="btn-secondary text-white text-sm font-bold py-2 px-4 rounded-lg">修改室友外觀</button>
                            <button onclick="goToStep(5)" class="btn-secondary text-white text-sm font-bold py-2 px-4 rounded-lg">修改關係與命名</button>
                        </div>
                        <div class="flex gap-2 mt-4 sm:mt-0">
                            <button id="copy-btn" onclick="copyTxt()" class="btn-secondary text-white font-bold py-2 px-6 rounded-lg w-full sm:w-auto">複製</button>
                            <button onclick="downloadTxt()" class="btn-primary font-bold py-2 px-6 rounded-lg w-full sm:w-auto">下載</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- SCRIPT LOGIC ---
        let currentStep = 1;
        const totalSteps = 6; 

        function populateTextCards(containerId, data, name, isCheckedFirst = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            data.forEach((item, index) => {
                const label = document.createElement('label');
                label.className = 'text-card-label';
                const checked = (isCheckedFirst && index === 0) ? 'checked' : '';
                const displayText = `${item.title} (${item.desc})`;
                label.innerHTML = `
                    <input type="radio" name="${name}" value="${item.code}" class="hidden" ${checked}>
                    <div class="text-card-content">
                        <span class="text-sm text-card-text">${displayText}</span>
                    </div>
                `;
                container.appendChild(label);
            });
        }
        
        function populateCards(containerId, data, name, isCheckedFirst = false, cardType = 'appearance') {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            data.forEach((item, index) => {
                const label = document.createElement('label');
                label.className = 'card-label';
                const checked = (isCheckedFirst && index === 0) ? 'checked' : '';
                
                let visualElement = '';
                if (cardType === 'zodiac') {
                    visualElement = `<div class="zodiac-emoji">${item.symbol || '?'}</div>`;
                } else if (cardType === 'icon') {
                    visualElement = `<div class="icon-emoji">${item.symbol || '?'}</div>`;
                } else { // appearance
                    const imagePath = `images/${item.code}.png`;
                    const fallbackImage = `https://placehold.co/400x400/2a2a2a/EAEAEA?text=${encodeURIComponent(item.title)}`;
                    visualElement = `<img src="${imagePath}" alt="${item.title}" onerror="this.onerror=null;this.src='${fallbackImage}';">`;
                }

                label.innerHTML = `
                    <input type="radio" name="${name}" value="${item.code}" class="hidden" ${checked}>
                    <div class="card">
                        ${visualElement}
                        <div class="card-content">
                            <p class="card-title">${item.title}</p>
                            ${item.desc ? `<p class="card-desc">${item.desc.replace(/\s*,\s*/g, ' ')}</p>` : ''}
                        </div>
                        <div class="check-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check" viewBox="0 0 16 16" style="color: var(--text-dark);">
                                <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                            </svg>
                        </div>
                    </div>
                `;
                container.appendChild(label);
            });
        }

        function updateAppearanceOptions(genderRadioName, appearanceContainerId) {
            const genderRadio = document.querySelector(`input[name="${genderRadioName}"]:checked`);
            if (!genderRadio) return;
            const gender = genderRadio.value;
            const appearanceOptions = gender === 'G01' ? gameData.appearance.male : gameData.appearance.female;
            populateCards(appearanceContainerId, appearanceOptions, appearanceContainerId, true, 'appearance');
        }

        function updateRoommateGenderOptions() {
            const playerSexuality = getRadioValue('playerSexuality');
            let filteredGenders = gameData.gender;
            if (playerSexuality === 'X01') {
                filteredGenders = gameData.gender.filter(g => g.code === 'G01');
            } else if (playerSexuality === 'X02') {
                filteredGenders = gameData.gender.filter(g => g.code === 'G02');
            }
            populateCards('roommateGender', filteredGenders, 'roommateGender', true, 'icon');
            updateAppearanceOptions('roommateGender', 'roommateAppearance');
        }

        function initializeForm() {
            if (typeof gameData === 'undefined') {
                const container = document.getElementById('game-setup-container');
                container.innerHTML = `<div class="text-center text-red-400">錯誤：無法載入遊戲設定檔 (gameData.js)。<br>請確認檔案存在且格式正確。</div>`;
                return;
            }

            populateCards('playerGender', gameData.gender, 'playerGender', true, 'icon');
            populateCards('playerSexuality', gameData.sexuality, 'playerSexuality', true, 'icon');
            populateCards('playerProfession', gameData.profession, 'playerProfession', true, 'icon');
            populateCards('playerZodiac', gameData.zodiac, 'playerZodiac', true, 'zodiac');
            populateCards('playerBloodType', gameData.bloodType, 'playerBloodType', true, 'icon');
            updateAppearanceOptions('playerGender', 'playerAppearance');
            
            populateCards('roommateZodiac', gameData.zodiac, 'roommateZodiac', true, 'zodiac');
            populateCards('roommateBloodType', gameData.bloodType, 'roommateBloodType', true, 'icon');
            populateCards('roommateProfession', gameData.profession, 'roommateProfession', true, 'icon');
            populateCards('roommateIntimacy', gameData.intimacy, 'roommateIntimacy', true, 'icon');
            populateTextCards('initialRelationship', gameData.initialRelationship, 'initialRelationship', true);
            
            updateRoommateGenderOptions();

            document.getElementById('playerGender').addEventListener('change', () => updateAppearanceOptions('playerGender', 'playerAppearance'));
            document.getElementById('playerSexuality').addEventListener('change', updateRoommateGenderOptions);
            document.getElementById('roommateGender').addEventListener('change', () => updateAppearanceOptions('roommateGender', 'roommateAppearance'));
        }
        
        function showStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById(`step-${stepNumber}`).classList.add('active');
            window.scrollTo(0, 0);
        }

        function goToStep(stepNumber) {
            currentStep = stepNumber;
            showStep(currentStep);
        }

        function validateStep(stepNumber) {
            const stepElement = document.getElementById(`step-${stepNumber}`);
            const errorMessageElement = stepElement.querySelector('.error-message');
            
            if (errorMessageElement) errorMessageElement.textContent = '';
            
            stepElement.querySelectorAll('input.invalid').forEach(input => {
                input.classList.remove('invalid');
            });

            const textInputs = stepElement.querySelectorAll('input[type="text"]');
            for (const input of textInputs) {
                if (!input.value.trim()) {
                    input.classList.add('invalid');
                    if (errorMessageElement) {
                        const label = document.querySelector(`label[for="${input.id}"]`);
                        const fieldName = label ? label.textContent : '必填欄位';
                        errorMessageElement.textContent = `請填寫「${fieldName}」！`;
                    }
                    return false; 
                }
            }
            return true;
        }

        function nextStep() {
            if (!validateStep(currentStep)) return;

            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            }
        }
        
        function showSummary() {
            if (!validateStep(currentStep)) return;
            updateSummaryPage();
            const output = generateFinalOutput();
            document.getElementById('summary-output').textContent = output;
            nextStep();
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function getRadioValue(name) {
            const checkedRadio = document.querySelector(`input[name="${name}"]:checked`);
            return checkedRadio ? checkedRadio.value : '';
        }

        function findDataItem(dataArray, code) {
            return dataArray.find(item => item.code === code) || { text: 'N/A', title: 'N/A', full_text: 'N/A' };
        }

        function updateSummaryPage() {
            const data = getAllSelections();
            const container = document.getElementById('summary-visual');

            const playerApp = data.playerGender.code === 'G01' 
                ? findDataItem(gameData.appearance.male, data.playerAppearance.code) 
                : findDataItem(gameData.appearance.female, data.playerAppearance.code);

            const roommateApp = data.roommateGender.code === 'G01'
                ? findDataItem(gameData.appearance.male, data.roommateAppearance.code)
                : findDataItem(gameData.appearance.female, data.roommateAppearance.code);

            container.innerHTML = `
                <div class="summary-card">
                    <h3 class="summary-title">玩家</h3>
                    <img src="images/${data.playerAppearance.code}.png" alt="${playerApp.title}" onerror="this.onerror=null;this.src='https://placehold.co/400x400/2a2a2a/EAEAEA?text=Player';">
                    <div class="summary-details">
                        <p><span>姓名:</span> ${data.playerName}</p>
                        <p><span>性別:</span> ${data.playerGender.text}</p>
                        <p><span>性向:</span> ${data.playerSexuality.text}</p>
                        <p><span>職業:</span> ${data.playerProfession.title}</p>
                        <p><span>外觀:</span> ${playerApp.title}</p>
                        <p><span>星座:</span> ${data.playerZodiac.title}</p>
                        <p><span>血型:</span> ${data.playerBloodType.title}</p>
                    </div>
                </div>
                <div class="summary-card">
                    <h3 class="summary-title">室友</h3>
                    <img src="images/${data.roommateAppearance.code}.png" alt="${roommateApp.title}" onerror="this.onerror=null;this.src='https://placehold.co/400x400/2a2a2a/EAEAEA?text=Roommate';">
                    <div class="summary-details">
                        <p><span>姓名:</span> ${data.roommateName}</p>
                        <p><span>性別:</span> ${data.roommateGender.text}</p>
                        <p><span>職業:</span> ${data.roommateProfession.title}</p>
                        <p><span>外觀:</span> ${roommateApp.title}</p>
                        <p><span>星座:</span> ${data.roommateZodiac.title}</p>
                        <p><span>血型:</span> ${data.roommateBloodType.title}</p>
                    </div>
                </div>
            `;
        }
        
        function getAllSelections() {
             return {
                playerName: document.getElementById('playerName').value,
                playerGender: findDataItem(gameData.gender, getRadioValue('playerGender')),
                playerSexuality: findDataItem(gameData.sexuality, getRadioValue('playerSexuality')),
                playerProfession: findDataItem(gameData.profession, getRadioValue('playerProfession')),
                playerZodiac: findDataItem(gameData.zodiac, getRadioValue('playerZodiac')),
                playerBloodType: findDataItem(gameData.bloodType, getRadioValue('playerBloodType')),
                playerAppearance: { code: getRadioValue('playerAppearance') },
                roommateName: document.getElementById('roommateName').value,
                roommateGender: findDataItem(gameData.gender, getRadioValue('roommateGender')),
                roommateZodiac: findDataItem(gameData.zodiac, getRadioValue('roommateZodiac')),
                roommateBloodType: findDataItem(gameData.bloodType, getRadioValue('roommateBloodType')),
                roommateProfession: findDataItem(gameData.profession, getRadioValue('roommateProfession')),
                roommateAppearance: { code: getRadioValue('roommateAppearance') },
                roommateIntimacy: findDataItem(gameData.intimacy, getRadioValue('roommateIntimacy')),
                initialRelationship: findDataItem(gameData.initialRelationship, getRadioValue('initialRelationship')),
                roommateNickname: document.getElementById('roommateNickname').value,
            };
        }

        function generateFinalOutput() {
            const data = getAllSelections();

            const playerApp = data.playerGender.code === 'G01' 
                ? findDataItem(gameData.appearance.male, data.playerAppearance.code) 
                : findDataItem(gameData.appearance.female, data.playerAppearance.code);

            const roommateApp = data.roommateGender.code === 'G01'
                ? findDataItem(gameData.appearance.male, data.roommateAppearance.code)
                : findDataItem(gameData.appearance.female, data.roommateAppearance.code);

            const playerID = `UR-${data.playerGender.code}${data.playerAppearance.code}${data.playerZodiac.code}${data.playerBloodType.code}-${data.playerSexuality.code}${data.playerProfession.code}`;
            const roommateID = `PL-${data.roommateGender.code}${data.roommateAppearance.code}${data.roommateZodiac.code}${data.roommateBloodType.code}-${data.roommateIntimacy.code}${data.roommateProfession.code}${data.initialRelationship.code}`;

            const output = `--- 玩家設定 ---
姓名: ${data.playerName}
稱呼: ${data.roommateNickname}
身份號: ${playerID}
性別: ${data.playerGender.text}
性向: ${data.playerSexuality.text}
職業: ${data.playerProfession.full_text}
外觀: ${playerApp.full_text}
星座: ${data.playerZodiac.full_text}
血型: ${data.playerBloodType.full_text}

--- 室友設定 ---
姓名: ${data.roommateName}
身份號: ${roommateID}
性別: ${data.roommateGender.text}
外觀: ${roommateApp.full_text}
星座: ${data.roommateZodiac.full_text}
血型: ${data.roommateBloodType.full_text}
職業: ${data.roommateProfession.full_text}
初始關係: ${data.initialRelationship.full_text}
親密行為風格: ${data.roommateIntimacy.full_text}`;
            
            return output.trim();
        }

        function downloadTxt() {
            const text = document.getElementById('summary-output').textContent;
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'RoommateLoveGuide_Settings.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function copyTxt() {
            const textToCopy = document.getElementById('summary-output').textContent;
            const copyButton = document.getElementById('copy-btn');
            
            const textArea = document.createElement('textarea');
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            
            textArea.select();
            document.execCommand('copy');
            
            document.body.removeChild(textArea);

            const originalText = copyButton.textContent;
            copyButton.textContent = '已複製！';
            setTimeout(() => {
                copyButton.textContent = originalText;
            }, 2000);
        }

        document.addEventListener('DOMContentLoaded', initializeForm);
    </script>

</body>
</html>