<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šæ›¸åº«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
    .view { display: none !important; } /* æ‰€æœ‰è¦–åœ–é è¨­éš±è—ï¼Œä¸¦å¼·åˆ¶åŸ·è¡Œ */
    .view.active { display: block !important; } /* ä½¿ç”¨ .active ä¾†é¡¯ç¤ºè¦–åœ–ï¼Œä¸¦å¼·åˆ¶åŸ·è¡Œ */
    
    /* é‡å°å…§å®¹å€åŸŸçš„æ»¾å‹•æ¢æ¨£å¼ */
    .scrollable-content {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; /* æå‡ iOS ä¸Šçš„æ»¾å‹•æµæš¢åº¦ */
    }
    .scrollable-content::-webkit-scrollbar {
        display: none; /* éš±è—æ»¾å‹•æ¢ */
    }
    .scrollable-content {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }

    /* å›ºå®šé ‚éƒ¨æ¬„æ¨£å¼ */
    .fixed-top-bar {
        position: fixed; /* çµ•å°å›ºå®š */
        top: 0;
        left: 0; 
        right: 0; /* ä½”æ“šæ•´å€‹å¯¬åº¦ */ 
        z-index: 100; /* ç¢ºä¿åœ¨å…¶ä»–å…§å®¹ä¹‹ä¸Š */
        background-color: var(--tw-bg-opacity, #ffffff); /* é©æ‡‰æš—è‰²æ¨¡å¼çš„èƒŒæ™¯è‰² */
        backdrop-filter: blur(8px); /* èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
        -webkit-backdrop-filter: blur(8px); /* å…¼å®¹ Safari */
        padding: 0.75rem; /* å…§é‚Šè· */
        border-bottom-left-radius: 0.5rem; /* åœ“è§’ */ 
        border-bottom-right-radius: 0.5rem; /* åœ“è§’ */ 
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* é™°å½± */ 
    }
    /* ç‚ºå°èªªç« ç¯€å…§å®¹å€åŸŸé ç•™ç©ºé–“ */
    #novel-view.active .content-area { 
        padding-top: 100px; /* æ ¹æ“š fixed-top-bar çš„å¯¦éš›é«˜åº¦èª¿æ•´æ­¤å€¼ */ 
    }
    /* èª¿æ•´ novel-author åœ¨æ‰‹æ©Ÿè¢å¹•çš„é–“è· */
    #fixed-header-bar #novel-author {
        margin-top: 0.25rem; /* é è¨­é–“è· */
    }
    @media (min-width: 640px) { /* sm è¢å¹•ä»¥ä¸Š */
        #fixed-header-bar #novel-author {
            margin-top: 0; /* åœ¨å¤§è¢å¹•ä¸Šç§»é™¤é ‚éƒ¨é–“è·ï¼Œä¿æŒèˆ‡æ¨™é¡Œå°é½Š */
            margin-left: 0.5rem; /* è®“ä½œè€…ååœ¨æ¨™é¡Œæ—æœ‰é–“è· */
        }
    }


    /* R18 æç¤ºæ¡†æ¨£å¼ */
    .r18-modal {
        display: none; /* é è¨­éš±è— */
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 200;
    }
    .r18-modal-content {
        background-color: #fff;
        color: #333;
        padding: 2rem;
        border-radius: 1rem;
        text-align: center;
        max-width: 400px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .dark .r18-modal-content {
        background-color: #1f2937; /* dark:bg-gray-800 */
        color: #d1d5db; /* dark:text-gray-200 */
    }

    /* ç¢ºä¿ age-gate-view å¼·åˆ¶ç½®ä¸­ (æ­¤è¦–åœ–å·²ç§»é™¤ï¼Œä½†ä¿ç•™æ¨£å¼ä»¥é˜²è¬ä¸€æˆ–æœªä¾†ä½¿ç”¨) */
    #age-gate-view.active { 
        display: flex !important; /* ç¢ºä¿ Flexbox å•Ÿç”¨ */ 
        align-items: center !important; /* å‚ç›´å±…ä¸­ */ 
        justify-content: center !important; /* æ°´å¹³å±…ä¸­ */ 
        position: fixed !important; /* å¼·åˆ¶å›ºå®šå®šä½ */ 
        top: 0 !important; 
        left: 0 !important; 
        right: 0 !important; 
        bottom: 0 !important; /* ç¢ºä¿ä½”æ»¿æ•´å€‹è¦–çª— */ 
        z-index: 50 !important; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */ 
        background-color: rgba(17, 24, 39, 0.8) !important; /* bg-gray-900 bg-opacity-80 çš„ RGB å€¼ */ 
        padding: 1rem !important; /* p-4 çš„é è¨­å€¼ */ 
    }

    /* ç‚º Markdown æ¸²æŸ“çš„æ®µè½æ·»åŠ é–“è· */
    #content-body p {
        margin-bottom: 1rem; /* å¢åŠ æ®µè½ä¸‹é‚Šè·ï¼Œæ¨¡æ“¬æ›è¡Œæ•ˆæœ */
    }
    #content-body p:last-child {
        margin-bottom: 0; /* æœ€å¾Œä¸€å€‹æ®µè½ä¸éœ€è¦ä¸‹é‚Šè· */
    }
</style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="fixed-header-bar" class="fixed-top-bar bg-white dark:bg-gray-800"> 
        <div class="flex flex-col gap-2 px-2"> <div class="flex items-center justify-between w-full">
                <button id="back-to-library" class="text-violet-500 hover:underline flex-shrink-0 whitespace-nowrap">&larr; è¿”å›æ›¸åº«</button>
                <a href="index.html" class="text-violet-500 hover:underline flex-shrink-0 whitespace-nowrap ml-4">è¿”å›é¦–é </a>
                
                <div class="flex items-baseline min-w-0 flex-grow justify-end"> <h1 id="novel-title" class="text-lg sm:text-xl font-bold text-violet-600 dark:text-violet-400 truncate"></h1>
                    <p id="novel-author" class="text-xs text-gray-700 dark:text-gray-300 truncate sm:mt-0 sm:ml-2"></p>
                </div>
            </div>
            
            <div class="flex items-center justify-center sm:justify-between w-full">
                <label for="chapter-select" class="sr-only">é¸æ“‡ç« ç¯€</label>
                <select id="chapter-select" class="block flex-grow p-1 sm:p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:ring-violet-500 focus:border-violet-500 transition duration-150 ease-in-out text-xs sm:text-sm">
                    <option value="">è«‹é¸æ“‡ç« ç¯€</option>
                </select>
                <div class="flex items-center space-x-1 sm:space-x-2 flex-shrink-0 ml-2"> <button id="first-chapter" class="p-1 sm:p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 text-base sm:text-lg">â®ï¸</button>
                    <button id="prev-chapter" class="p-1 sm:p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 text-base sm:text-lg">â—€ï¸</button>
                    <button id="next-chapter" class="p-1 sm:p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 text-base sm:text-lg">â–¶ï¸</button>
                    <button id="last-chapter" class="p-1 sm:p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 text-base sm:text-lg">â­ï¸</button>
                </div>
            </div>
        </div>
    </div>

    <div id="r18-modal" class="r18-modal hidden">
        <div class="r18-modal-content">
            <h3 class="text-xl font-bold mb-4">å…§å®¹è­¦å‘Š</h3>
            <p class="mb-6">æ­¤ç« ç¯€åŒ…å«é™åˆ¶ç´šå…§å®¹ï¼Œæœªæ»¿18æ­²è€…è«‹å‹¿è§€çœ‹ã€‚</p>
            <button id="r18-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mr-2">æˆ‘å·²æ»¿18æ­²</button>
            <button id="r18-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="age-gate-view" class="view fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 text-center max-w-sm w-full">
            <h2 id="age-gate-title" class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4">å¹´é½¡ç¢ºèª</h2>
            <p id="age-gate-message" class="text-gray-600 dark:text-gray-400 mb-8">æœ¬ç¶²ç«™å…§å®¹å¯èƒ½ä¸é©åˆæœªæ»¿18æ­²çš„ä½¿ç”¨è€…ï¼Œ<br>æ‚¨æ˜¯å¦å·²å¹´æ»¿18æ­²ï¼Ÿ</p>
            <div id="age-gate-buttons" class="flex justify-center gap-4">
                <button id="btnYes" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105">æ˜¯ï¼Œæˆ‘å·²æ»¿18æ­²</button>
                <button id="btnNo" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105">å¦</button>
            </div>
        </div>
    </div>

    <div id="book-list-view" class="view active container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-violet-600 dark:text-violet-400">ç·šä¸Šæ›¸åº«</h1>
            <p class="mt-4 text-lg text-gray-700 dark:text-gray-300">ä½œè€…ï¼šæ³•å¼è‰è“å¸ƒä¸</p>
            
            <div class="mt-6 flex flex-col items-center justify-center gap-2">
                <input type="text" id="tag-search-input" placeholder="æœå°‹æ¨™ç±¤ (ä¾‹å¦‚: å°èªª-R18)" 
                       class="w-full max-w-xs p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-violet-500 focus:border-violet-500">
                <div class="flex justify-center gap-2 w-full max-w-xs"> 
                    <button id="tag-search-btn" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 flex-grow">æœå°‹</button>
                    <button id="tag-reset-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 flex-grow">é‡ç½®</button>
                    <a href="index.html" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105 flex-grow">è¿”å›é¦–é </a>
                </div>
            </div>
        </header>
        <main id="book-list" class="grid grid-cols-1 gap-4"> <p id="loading-books-text" class="text-gray-500 col-span-full text-center">æ­£åœ¨è¼‰å…¥æ›¸åº«...</p>
        </main>
    </div>

    <div id="novel-view" class="view container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl"> 
        <main class="content-area bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg flex flex-col h-full scrollable-content"> 
            <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">ç« ç¯€å…§å®¹</h2>
            <div id="content-title" class="mt-2 mb-2 text-2xl font-bold text-gray-800 dark:text-gray-200"></div>
            <p id="content-note" class="mt-1 text-sm text-gray-500 dark:text-gray-400"></p>
            <div id="chapter-image-container" class="w-full flex justify-center mb-4"></div>
            <div id="content-body" class="leading-relaxed flex-grow text-lg md:text-xl"><p class="text-gray-500">è«‹å¾ä¸Šæ–¹é¸æ“‡ä¸€å€‹ç« ç¯€ã€‚</p></div> 

            <div class="mt-4 text-center text-xs text-gray-400 dark:text-gray-500 pb-2 flex-shrink-0">
                <p>&copy; 2025. All rights reserved.</p>
            </div>
        </main>
    </div>

<script>
    // --- å…¨åŸŸè®Šæ•¸å’Œ DOM å…ƒç´  ---
    let allNovels = []; // å„²å­˜æ‰€æœ‰å°èªªæ•¸æ“š
    let filteredNovels = []; // å„²å­˜ç¶“éæ¨™ç±¤ç¯©é¸å¾Œçš„å°èªª
    let currentNovel = null; // ç•¶å‰æ­£åœ¨é–±è®€çš„å°èªª
    let currentChapterIndex = 0; // ç•¶å‰é–±è®€çš„ç« ç¯€ç´¢å¼•

    let views = {}; 
    let chapterSelect; 
    let fixedHeaderBar;
    let r18Modal;
    let r18ConfirmBtn;
    let r18CancelBtn;
    let tagSearchInput;
    let tagSearchBtn;
    let tagResetBtn;
    let chapterImageContainer; // æ–°å¢åœ–ç‰‡å®¹å™¨è®Šæ•¸

    // --- æ ¸å¿ƒé‚è¼¯ ---
    document.addEventListener('DOMContentLoaded', () => {
        // åœ¨ DOMContentLoaded å…§éƒ¨ç²å–æ‰€æœ‰ DOM å…ƒç´ 
        views = {
            // ageGate: document.getElementById('age-gate-view'), // ç§»é™¤ ageGate è¦–åœ–çš„å¼•ç”¨
            bookList: document.getElementById('book-list-view'),
            novel: document.getElementById('novel-view')
        };
        chapterSelect = document.getElementById('chapter-select');
        fixedHeaderBar = document.getElementById('fixed-header-bar');
        r18Modal = document.getElementById('r18-modal');
        r18ConfirmBtn = document.getElementById('r18-confirm-btn');
        r18CancelBtn = document.getElementById('r18-cancel-btn');
        tagSearchInput = document.getElementById('tag-search-input');
        tagSearchBtn = document.getElementById('tag-search-btn');
        tagResetBtn = document.getElementById('tag-reset-btn');
        chapterImageContainer = document.getElementById('chapter-image-container'); // ç²å–åœ–ç‰‡å®¹å™¨

        // åˆå§‹éš±è—å›ºå®šé ‚éƒ¨æ¬„
        if (fixedHeaderBar) { 
            fixedHeaderBar.style.display = 'none';
        }

        // ç›´æ¥é¡¯ç¤ºæ›¸åº«åˆ—è¡¨ï¼Œä¸å†é€²è¡Œåˆå§‹å¹´é½¡é©—è­‰
        showView('bookList');
        loadLibrary();
        
        // --- äº‹ä»¶ç›£è½å™¨ ---
        // ç§»é™¤å¹´é½¡é©—è­‰æŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨ (å› ç‚º age-gate-view å·²ä¸å†ä½¿ç”¨)
        // const btnYes = document.getElementById('btnYes');
        // const btnNo = document.getElementById('btnNo');
        // if (btnYes) btnYes.addEventListener('click', handleAgeGateYes);
        // if (btnNo) btnNo.addEventListener('click', handleAgeGateNo);

        document.getElementById('back-to-library').addEventListener('click', () => showView('bookList'));
        
        if (chapterSelect) { 
            chapterSelect.addEventListener('change', (event) => {
                const selectedIndex = parseInt(event.target.value); // ç¢ºä¿æ˜¯æ•¸å­—
                if (!isNaN(selectedIndex) && selectedIndex >= 0) { // ç¢ºä¿æ˜¯æœ‰æ•ˆç´¢å¼•
                    currentChapterIndex = selectedIndex;
                    loadChapterWithR18Check(currentNovel.folder, currentNovel.chapters[currentChapterIndex]);
                }
            });
        }

        // åˆ†é æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
        document.getElementById('first-chapter').addEventListener('click', () => goToChapter(0));
        document.getElementById('prev-chapter').addEventListener('click', () => goToChapter(currentChapterIndex - 1));
        document.getElementById('next-chapter').addEventListener('click', () => goToChapter(currentChapterIndex + 1));
        document.getElementById('last-chapter').addEventListener('click', () => goToChapter(currentNovel.chapters.length - 1));

        // R18 å½ˆçª—æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
        if (r18ConfirmBtn) r18ConfirmBtn.addEventListener('click', confirmR18);
        if (r18CancelBtn) r18CancelBtn.addEventListener('click', cancelR18);

        // Tag æœå°‹äº‹ä»¶ç›£è½å™¨
        if (tagSearchBtn) {
            console.log('Tag Search Button found. Attaching click listener.');
            tagSearchBtn.addEventListener('click', searchBooks);
        } else {
            console.error('Tag Search Button not found!');
        }
        
        if (tagSearchInput) {
            console.log('Tag Search Input found. Attaching keypress listener.');
            tagSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    console.log('Enter key pressed in search input.');
                    searchBooks();
                }
            });
        } else {
            console.error('Tag Search Input not found!');
        }

        if (tagResetBtn) {
            console.log('Tag Reset Button found. Attaching click listener.');
            tagResetBtn.addEventListener('click', () => {
                if (tagSearchInput) tagSearchInput.value = '';
                console.log('Reset button clicked. Calling searchBooks.');
                searchBooks(); // é‡ç½®å¾Œå†æ¬¡æœå°‹ (é¡¯ç¤ºæ‰€æœ‰)
            });
        } else {
            console.error('Tag Reset Button not found!');
        }
    });

    // --- è¦–åœ–ç®¡ç† ---
    function showView(viewName) {
        Object.values(views).forEach(view => {
            view.classList.remove('active');
        });
        if (views[viewName]) {
            views[viewName].classList.add('active');
        }

        // æ ¹æ“šè¦–åœ–é¡¯ç¤ºæˆ–éš±è—å›ºå®šé ‚éƒ¨æ¬„
        if (fixedHeaderBar) { 
            if (viewName === 'novel') {
                fixedHeaderBar.style.display = 'block';
            } else {
                fixedHeaderBar.style.display = 'none';
            }
        }
    }

    // --- R18 é©—è­‰é‚è¼¯ ---
    let pendingChapterLoad = null; // å„²å­˜å¾…è¼‰å…¥çš„ç« ç¯€è³‡è¨Š

    function loadChapterWithR18Check(folder, chapter) {
        if (chapter.isR18) {
            // å¦‚æœæ˜¯ R18 ç« ç¯€ï¼Œä¸”ç”¨æˆ¶æœªç¢ºèªéï¼Œå‰‡é¡¯ç¤ºå½ˆçª—
            if (sessionStorage.getItem('isAgeVerifiedForR18') !== 'true') {
                r18Modal.classList.remove('hidden');
                r18Modal.style.display = 'flex'; // ç¢ºä¿é¡¯ç¤º
                pendingChapterLoad = { folder, chapter }; // å„²å­˜å¾…è¼‰å…¥ç« ç¯€
                return; // æš«åœè¼‰å…¥
            }
        }
        // å¦‚æœä¸æ˜¯ R18 æˆ–å·²é©—è­‰ï¼Œå‰‡ç›´æ¥è¼‰å…¥
        loadChapterContent(folder, chapter.file, chapter.title, chapter.note, chapter.hasChapterTitleInContent, chapter.img, chapter.imgWidth, chapter.imgHeight);
    }

    function confirmR18() {
        sessionStorage.setItem('isAgeVerifiedForR18', 'true');
        r18Modal.classList.add('hidden');
        r18Modal.style.display = 'none'; // ç¢ºä¿éš±è—
        if (pendingChapterLoad) {
            loadChapterContent(pendingChapterLoad.folder, pendingChapterLoad.chapter.file, pendingChapterLoad.chapter.title, pendingChapterLoad.chapter.note, pendingChapterLoad.chapter.hasChapterTitleInContent, pendingChapterLoad.chapter.img, pendingChapterLoad.chapter.imgWidth, pendingChapterLoad.chapter.imgHeight);
            pendingChapterLoad = null;
        }
    }

    function cancelR18() {
        r18Modal.classList.add('hidden');
        r18Modal.style.display = 'none'; // ç¢ºä¿éš±è—
        // å¦‚æœå–æ¶ˆï¼Œå¯ä»¥é¸æ“‡è¿”å›æ›¸åº«åˆ—è¡¨æˆ–åœç•™åœ¨ç•¶å‰é é¢
        showView('bookList'); 
    }

    // --- è³‡æ–™è¼‰å…¥èˆ‡æ¸²æŸ“ ---
    async function loadLibrary() {
        const bookListContainer = document.getElementById('book-list');
        const loadingText = document.getElementById('loading-books-text');
        
        if (allNovels.length === 0) { // åªæœ‰åœ¨å°šæœªè¼‰å…¥æ™‚æ‰ fetch
            loadingText.textContent = "æ­£åœ¨è¼‰å…¥æ›¸åº«...";
            loadingText.className = 'text-gray-500 col-span-full text-center';

            try {
                const fetchUrl = 'filelist.json'; // ç¢ºèªè¦è¼‰å…¥çš„ URL
                console.log('å˜—è©¦å¾æ­¤ URL è¼‰å…¥ filelist.json:', fetchUrl); // å¢åŠ åµéŒ¯æ—¥èªŒ

                const response = await fetch(fetchUrl);
                
                if (!response.ok) {
                    // å¦‚æœ HTTP ç‹€æ…‹ç¢¼ä¸æ˜¯ 2xxï¼Œå‰‡æ‹‹å‡ºéŒ¯èª¤
                    console.error(`è¼‰å…¥ filelist.json å¤±æ•— - ç‹€æ…‹ç¢¼: ${response.status}, URL: ${response.url}`);
                    throw new Error(`ç„¡æ³•è¼‰å…¥ filelist.json: ç‹€æ…‹ç¢¼ ${response.status}`);
                }

                const data = await response.json();

                if (!Array.isArray(data) || data.length === 0) {
                    bookListContainer.innerHTML = '<p class="text-red-500 col-span-full text-center">`filelist.json` æ˜¯ç©ºçš„æˆ–æ ¼å¼éŒ¯èª¤ã€‚</p>';
                    loadingText.style.display = 'none';
                    return;
                }

                allNovels = data; // å„²å­˜æ‰€æœ‰å°èªªæ•¸æ“š
                filteredNovels = [...allNovels]; // åˆå§‹æ™‚ç¯©é¸çµæœç­‰æ–¼æ‰€æœ‰å°èªª
                console.log('filelist.json è¼‰å…¥æˆåŠŸï¼Œæ‰€æœ‰å°èªª:', allNovels);

            } catch (error) {
                // æ•ç²æ‰€æœ‰è¼‰å…¥å’Œè§£æéç¨‹ä¸­çš„éŒ¯èª¤
                console.error('è¼‰å…¥æ›¸åº«å¤±æ•—:', error); 
                loadingText.textContent = `è¼‰å…¥æ›¸åº«å¤±æ•—: ${error.message}`;
                loadingText.className = 'text-red-500 col-span-full text-center';
                bookListContainer.innerHTML = '';
                return; // è¼‰å…¥å¤±æ•—å‰‡åœæ­¢
            }
        }
        // ç„¡è«–æ˜¯åˆæ¬¡è¼‰å…¥é‚„æ˜¯é‡æ–°ç¯©é¸ï¼Œéƒ½èª¿ç”¨ renderBookList
        renderBookList(filteredNovels);
    }

    function renderBookList(novelsToDisplay) {
        const bookListContainer = document.getElementById('book-list');
        const loadingText = document.getElementById('loading-books-text');

        // ä¿®æ­£ï¼šåªæœ‰ç•¶ loadingText å…ƒç´ å­˜åœ¨æ™‚æ‰å˜—è©¦éš±è—å®ƒ
        if (loadingText) { 
            loadingText.style.display = 'none'; 
        }
        bookListContainer.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹

        if (novelsToDisplay.length === 0) {
            bookListContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æ›¸æœ¬ã€‚</p>';
            return;
        }

        novelsToDisplay.forEach(novel => {
            if (!novel.title || !novel.author || !Array.isArray(novel.chapters)) {
                console.warn('åµæ¸¬åˆ°ä¸å®Œæ•´çš„å°èªªè³‡æ–™:', novel);
                return;
            }

            const card = document.createElement('div');
            card.className = "bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer flex items-center justify-between"; // Flex æ©«å¼ä½ˆå±€
            
            let tagsHtml = '';
            if (novel.tags) {
                const tags = novel.tags.split('-').map(tag => `<span class="inline-block bg-violet-200 dark:bg-violet-700 text-violet-800 dark:text-violet-200 text-xs px-2 py-1 rounded-full">${tag.trim()}</span>`).join(' ');
                tagsHtml = `<div class="flex flex-wrap gap-1 mt-2">${tags}</div>`;
            }

            card.innerHTML = `
                <div class="flex-grow">
                    <h2 class="text-xl font-bold text-violet-700 dark:text-violet-400">${novel.title}</h2>
                    <p class="mt-1 text-gray-600 dark:text-gray-400">ä½œè€…ï¼š${novel.author}</p>
                    ${tagsHtml}
                </div>
                <div class="text-right text-sm text-gray-500 dark:text-gray-500 flex-shrink-0 ml-4">
                    å…± ${novel.chapters.length} ç« 
                </div>
            `;
            card.addEventListener('click', () => renderNovelView(novel));
            bookListContainer.appendChild(card);
        });
        console.log('å·²æ¸²æŸ“æ›¸æœ¬åˆ—è¡¨ï¼Œé¡¯ç¤ºæ•¸é‡:', novelsToDisplay.length);
    }

    function searchBooks() {
        const searchTerm = tagSearchInput.value.toLowerCase().trim();
        console.log('åŸ·è¡Œæœå°‹ï¼Œæœå°‹è©:', searchTerm); // åµéŒ¯æ—¥èªŒ
        if (searchTerm === '') {
            filteredNovels = [...allNovels]; // å¦‚æœæœå°‹è©ç‚ºç©ºï¼Œé¡¯ç¤ºæ‰€æœ‰å°èªª
            console.log('æœå°‹è©ç‚ºç©ºï¼Œé¡¯ç¤ºæ‰€æœ‰å°èªªã€‚');
        } else {
            filteredNovels = allNovels.filter(novel => {
                const novelTags = novel.tags ? novel.tags.toLowerCase() : '';
                const includesTerm = novelTags.includes(searchTerm);
                console.log(`å°èªª: ${novel.title}, æ¨™ç±¤: "${novelTags}", æœå°‹è©: "${searchTerm}", åŒ…å«: ${includesTerm}`); // åµéŒ¯æ—¥èªŒ
                return includesTerm;
            });
        }
        console.log('ç¯©é¸å¾Œçš„å°èªªæ•¸é‡:', filteredNovels.length); // åµéŒ¯æ—¥èªŒ
        renderBookList(filteredNovels);
    }


    function chineseToArabic(chineseNumStr) {
        const numMap = {
            'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5,
            'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9
        };

        if (chineseNumStr === 'å') {
            return 10;
        }

        if (chineseNumStr.startsWith('å')) { // e.g., "åä¸€", "åä¸ƒ"
            const unit = chineseNumStr.substring(1); // "ä¸€", "ä¸ƒ"
            return 10 + (numMap[unit] || 0);
        }

        if (chineseNumStr.includes('å')) { // e.g., "äºŒå", "äºŒåä¸‰"
            const parts = chineseNumStr.split('å');
            const tensDigit = numMap[parts[0]]; // "äºŒ" -> 2
            const unitDigit = parts[1] ? numMap[parts[1]] : 0; // "ä¸‰" -> 3, or 0 for "äºŒå"
            return tensDigit * 10 + unitDigit;
        }

        // Fallback for single digits (though not strictly needed as they are Arabic in JSON)
        if (numMap[chineseNumStr] !== undefined) {
            return numMap[chineseNumStr];
        }

        return chineseNumStr; // Return original if no match
    }

    function renderNovelView(novel) {
        currentNovel = novel; // å„²å­˜ç•¶å‰å°èªª
        currentChapterIndex = 0; // é è¨­å¾ç¬¬ä¸€ç« é–‹å§‹

        document.getElementById('novel-title').textContent = novel.title;
        document.getElementById('novel-author').textContent = `ä½œè€…ï¼š${novel.author}`;
        // document.getElementById('novel-author-mobile').textContent = `ä½œè€…ï¼š${novel.author}`; // ç§»é™¤æ­¤è¡Œï¼Œå› ç‚ºå·²çµ±ä¸€

        // æ¸…ç©ºèˆŠé¸é …ï¼Œä¸¦æ·»åŠ é è¨­é¸é …
        chapterSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç« ç¯€</option>';
        novel.chapters.forEach((chapter, index) => {
            const option = document.createElement('option');
            option.value = index; // ä½¿ç”¨ç´¢å¼•ä½œç‚ºå€¼
            
            let displayChapterTitle = chapter.title;

            // Only apply conversion for "éçœ¼é›²ç…™" novel
            if (novel.title === "éçœ¼é›²ç…™") {
                const match = chapter.title.match(/ç¬¬(.*?)(ç« .*)/);
                if (match && match[1]) {
                    const chineseNumPart = match[1]; // e.g., "åä¸ƒ", "äºŒå"
                    const arabicNum = chineseToArabic(chineseNumPart);
                    // Only update if a conversion actually happened and it's different
                    if (typeof arabicNum === 'number' && arabicNum.toString() !== chineseNumPart) {
                        displayChapterTitle = `ç¬¬${arabicNum}${match[2]}`;
                    }
                }
            }

            // --- ä¿®æ”¹é–‹å§‹ ---
            let optionText = displayChapterTitle; // å…ˆå–å¾—ç« ç¯€æ¨™é¡Œ

            if (chapter.isR18) {
                // å¦‚æœæ˜¯ R18ï¼Œåœ¨æ¨™é¡Œå¾Œé¢åŠ ä¸Šæ¨™è¨˜
                optionText += " (R18)"; 
                // åŒæ™‚ä¿ç•™é›»è…¦ç‰ˆçš„ç´…è‰²æ¨£å¼
                option.classList.add('text-red-500');
            }
            
            option.textContent = optionText; // å°‡æœ€çµ‚çš„æ–‡å­—è¨­å®šçµ¦ option
            // --- ä¿®æ”¹çµæŸ ---
            
            chapterSelect.appendChild(option);
        });

        // é‡ç½®é¸å–®é¸æ“‡ç‚ºé è¨­å€¼
        chapterSelect.value = "";

        // æ¸…ç©ºå…§å®¹ï¼Œç­‰å¾…ç”¨æˆ¶é¸æ“‡ç« ç¯€
        document.getElementById('content-title').textContent = '';
        document.getElementById('content-body').innerHTML = '<p class="text-gray-500">è«‹å¾ä¸Šæ–¹é¸æ“‡ä¸€å€‹ç« ç¯€ã€‚</p>';
        document.getElementById('content-note').textContent = '';
        // ç¢ºä¿åœ–ç‰‡å®¹å™¨åœ¨è¼‰å…¥æ–°ç« ç¯€å‰æ¸…ç©º
        if (chapterImageContainer) {
            chapterImageContainer.innerHTML = '';
        }
        showView('novel');

        // å¦‚æœæœ‰ç« ç¯€ï¼Œè‡ªå‹•è¼‰å…¥ç¬¬ä¸€ç«  (ä¸¦é€²è¡ŒR18æª¢æŸ¥)
        if (novel.chapters.length > 0) {
            loadChapterWithR18Check(currentNovel.folder, currentNovel.chapters[currentChapterIndex]);
            updatePaginationButtons(); // æ›´æ–°åˆ†é æŒ‰éˆ•ç‹€æ…‹
        } else {
            // å¦‚æœæ²’æœ‰ç« ç¯€ï¼Œç¦ç”¨åˆ†é æŒ‰éˆ•
            updatePaginationButtons(true);
        }
    }

    async function loadChapterContent(folder, filename, displayTitle, note, hasChapterTitleInContent, img, imgWidth, imgHeight) {
        const contentTitle = document.getElementById('content-title');
        const contentBody = document.getElementById('content-body');
        const contentNote = document.getElementById('content-note');
        
        contentTitle.textContent = displayTitle;
        contentTitle.style.display = 'block';

        if (note) {
            contentNote.textContent = `ğŸ“ ${note}`;
            contentNote.style.display = 'block';
        } else {
            contentNote.textContent = '';
            contentNote.style.display = 'none';
        }
        contentBody.innerHTML = `<p class="text-gray-500">æ­£åœ¨è¼‰å…¥ç« ç¯€...</p>`;
        // æ¸…ç©ºåœ–ç‰‡å®¹å™¨
        if (chapterImageContainer) {
            chapterImageContainer.innerHTML = '';
        }
        
        try {
            const response = await fetch(`novels/${encodeURIComponent(folder)}/${encodeURIComponent(filename)}`);
            if (!response.ok) throw new Error(`æª”æ¡ˆè®€å–å¤±æ•— (${response.status})`);
            
            let markdownContent = await response.text(); 
            
            // æ ¹æ“š hasChapterTitleInContent åˆ¤æ–·æ˜¯å¦ç§»é™¤ç¬¬ä¸€è¡Œ
            if (hasChapterTitleInContent) {
                const lines = markdownContent.split('\n');
                if (lines.length > 1) {
                    markdownContent = lines.slice(1).join('\n');
                } else {
                    markdownContent = ''; // å¦‚æœåªæœ‰ä¸€è¡Œï¼Œå¯èƒ½æ˜¯åªåŒ…å«æ¨™é¡Œï¼Œå‰‡é¡¯ç¤ºç‚ºç©ºå…§å®¹
                }
            }

            const htmlContent = marked.parse(markdownContent, { gfm: true, breaks: true }); 
            
            // å¦‚æœæœ‰åœ–ç‰‡ï¼Œåœ¨å…§å®¹ä¸Šæ–¹é¡¯ç¤ºåœ–ç‰‡
            if (img && chapterImageContainer) {
                const imgPath = `novels/${encodeURIComponent(folder)}/img/${encodeURIComponent(img)}`;
                const imgElement = document.createElement('img');
                imgElement.src = imgPath;
                imgElement.alt = displayTitle;
                imgElement.className = "max-w-full h-auto rounded-lg shadow-md mb-4"; // éŸ¿æ‡‰å¼åœ–ç‰‡æ¨£å¼
                // è¨­å®šåœ–ç‰‡å°ºå¯¸ï¼Œé¿å… CLS
                if (imgWidth && imgHeight) {
                    imgElement.width = imgWidth;
                    imgElement.height = imgHeight;
                } else {
                    // æä¾›é è¨­å°ºå¯¸æˆ–ä½”ä½åœ–ï¼Œå¦‚æœ JSON ä¸­æ²’æœ‰æä¾›
                    // å°‡é è¨­å¯¬é«˜æ”¹ç‚º 800x800
                    imgElement.src = `https://placehold.co/800x800/cccccc/333333?text=No+Image`;
                    imgElement.alt = "åœ–ç‰‡è¼‰å…¥å¤±æ•—æˆ–ä¸å­˜åœ¨";
                    imgElement.width = 800; // è¨­å®šé è¨­å¯¬åº¦
                    imgElement.height = 800; // è¨­å®šé è¨­é«˜åº¦
                }
                chapterImageContainer.appendChild(imgElement);
            }

            contentBody.innerHTML = htmlContent; 

            // æ›´æ–°ä¸‹æ‹‰é¸å–®çš„é¸æ“‡
            if (chapterSelect) {
                chapterSelect.value = currentChapterIndex.toString();
            }
            updatePaginationButtons(); // è¼‰å…¥å…§å®¹å¾Œæ›´æ–°åˆ†é æŒ‰éˆ•ç‹€æ…‹

        } catch (error) {
            contentBody.innerHTML = `<p class="text-red-500">è¼‰å…¥ç« ç¯€æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}</p>`;
            updatePaginationButtons(true); // è¼‰å…¥å¤±æ•—å‰‡ç¦ç”¨æŒ‰éˆ•
        }
    }

    // --- ç« ç¯€åˆ†é åŠŸèƒ½ ---
    function goToChapter(index) {
        if (!currentNovel || !currentNovel.chapters || currentNovel.chapters.length === 0) {
            return; // æ²’æœ‰å°èªªæˆ–ç« ç¯€
        }

        const totalChapters = currentNovel.chapters.length;

        if (index < 0) {
            index = 0; // ä¸èƒ½å°æ–¼ç¬¬ä¸€ç« 
        } else if (index >= totalChapters) {
            index = totalChapters - 1; // ä¸èƒ½å¤§æ–¼æœ€å¾Œä¸€ç« 
        }

        currentChapterIndex = index;
        loadChapterWithR18Check(currentNovel.folder, currentNovel.chapters[currentChapterIndex]);
    }

    function updatePaginationButtons(disableAll = false) {
        const firstBtn = document.getElementById('first-chapter');
        const prevBtn = document.getElementById('prev-chapter');
        const nextBtn = document.getElementById('next-chapter');
        const lastBtn = document.getElementById('last-chapter');

        if (disableAll || !currentNovel || currentNovel.chapters.length === 0) {
            firstBtn.disabled = true;
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            lastBtn.disabled = true;
            return;
        }

        firstBtn.disabled = (currentChapterIndex === 0);
        prevBtn.disabled = (currentChapterIndex === 0);
        nextBtn.disabled = (currentChapterIndex === currentNovel.chapters.length - 1);
        lastBtn.disabled = (currentChapterIndex === currentNovel.chapters.length - 1);
    }

</script>
</body>
</html>