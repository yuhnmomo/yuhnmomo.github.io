<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸Šæ›¸åº«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
    .view { display: none !important; } /* æ‰€æœ‰è¦–åœ–é è¨­éš±è—ï¼Œä¸¦å¼·åˆ¶åŸ·è¡Œ */
    .view.active { display: block !important; } /* ä½¿ç”¨ .active ä¾†é¡¯ç¤ºè¦–åœ–ï¼Œä¸¦å¼·åˆ¶åŸ·è¡Œ */
    
    /* é‡å° novel-view å…§çš„æ»¾å‹•å€åŸŸ */
    .scrollable-content {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch; /* æå‡ iOS ä¸Šçš„æ»¾å‹•æµæš¢åº¦ */
    }
    /* éš±è—æ»¾å‹•æ¢ï¼Œä½†ä¿ç•™æ»¾å‹•åŠŸèƒ½ */
    .scrollable-content::-webkit-scrollbar {
        display: none;
    }
    .scrollable-content {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
    }

    /* å°‡ fixed-top-bar ä¿®æ”¹ç‚º position: fixedï¼Œä¸¦å®šç¾©å¯¬åº¦ */
    .fixed-top-bar {
        position: fixed; /* è®Šæ›´ç‚º fixed */
        top: 0;
        left: 0; 
        right: 0; /* è®“å®ƒä½”æ“šæ•´å€‹å¯¬åº¦ */ 
        z-index: 100; /* ç¢ºä¿åœ¨å…¶ä»–å…§å®¹ä¹‹ä¸Š */
        background-color: var(--tw-bg-opacity, #ffffff); /* ä½¿ç”¨ Tailwind CSS è®Šæ•¸ä¾†é©æ‡‰æš—è‰²æ¨¡å¼ï¼Œæä¾›ä¸€å€‹é è¨­å€¼ */
        /* å¢åŠ èƒŒæ™¯æ¨¡ç³Šæ•ˆæœï¼Œä½¿å…¶æ›´åƒä¸€å€‹æµ®å‹•çš„å°èˆªæ¬„ */
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px); /* å…¼å®¹ Safari */
        padding: 0.75rem; /* p-3 çš„é è¨­å€¼ */
        border-bottom-left-radius: 0.5rem; /* rounded-b-lg çš„é è¨­å€¼ */ 
        border-bottom-right-radius: 0.5rem; /* rounded-b-lg çš„é è¨­å€¼ */ 
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* shadow-lg çš„é è¨­å€¼ */ 
    }
    /* ç‚º novel-view å…§å®¹å€åŸŸé ç•™ç©ºé–“ */
    #novel-view.active .content-area { /* æ³¨æ„é€™è£¡çš„é¸æ“‡å™¨ */ 
        padding-top: 100px; /* æ ¹æ“š fixed-top-bar çš„å¯¦éš›é«˜åº¦èª¿æ•´æ­¤å€¼ */ 
        /* é€™å€‹å€¼éœ€è¦æ ¹æ“š fixed-top-bar çš„å¯¦éš›é«˜åº¦å’Œå…§é‚Šè·ä¾†ä¼°ç®—ï¼Œ
           æ‚¨å¯èƒ½éœ€è¦æ ¹æ“šå¯¦éš›é¡¯ç¤ºæƒ…æ³èª¿æ•´é€™å€‹æ•¸å­—ã€‚
           å¯ä»¥é€šéé–‹ç™¼è€…å·¥å…·æª¢æŸ¥ fixed-top-bar çš„ computed height ä¾†æ±ºå®šã€‚
           å¤§ç´„ 80px-120px ä¹‹é–“ï¼Œå–æ±ºæ–¼å…§å®¹å’Œpaddingã€‚ */
    }

    /* ç¢ºä¿ age-gate-view å¼·åˆ¶ç½®ä¸­ */
    #age-gate-view.active { /* åªåœ¨æ´»èºæ™‚å¼·åˆ¶ç½®ä¸­ */ 
        display: flex !important; /* ç¢ºä¿ Flexbox å•Ÿç”¨ */ 
        align-items: center !important; /* å‚ç›´å±…ä¸­ */ 
        justify-content: center !important; /* æ°´å¹³å±…ä¸­ */ 
        position: fixed !important; /* å¼·åˆ¶å›ºå®šå®šä½ */ 
        top: 0 !important; 
        left: 0 !important; 
        right: 0 !important; 
        bottom: 0 !important; /* ç¢ºä¿ä½”æ»¿æ•´å€‹è¦–çª— */ 
        z-index: 50 !important; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */ 
        background-color: rgba(17, 24, 39, 0.8) !important; /* bg-gray-900 bg-opacity-80 çš„ RGB å€¼ */ 
        padding: 1rem !important; /* p-4 çš„é è¨­å€¼ */ 
    }
</style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="fixed-header-bar" class="fixed-top-bar bg-white dark:bg-gray-800"> 
        <div class="flex items-center justify-between flex-wrap gap-2">
            <button id="back-to-library" class="text-violet-500 hover:underline inline-block flex-shrink-0">&larr; è¿”å›æ›¸åº«</button>
            
            <div class="flex-grow flex justify-center order-first md:order-none">
                <label for="chapter-select" class="sr-only">é¸æ“‡ç« ç¯€</label>
                <select id="chapter-select" class="block w-full max-w-xs p-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:ring-violet-500 focus:border-violet-500 transition duration-150 ease-in-out text-sm">
                    <option value="">è«‹é¸æ“‡ç« ç¯€</option>
                </select>
            </div>

            <div class="flex-grow text-center min-w-0 order-last md:order-none">
                <h1 id="novel-title" class="text-lg sm:text-xl font-bold text-violet-600 dark:text-violet-400 truncate"></h1>
                <p id="novel-author" class="text-xs text-gray-700 dark:text-gray-300 truncate hidden md:block"></p>
                <p id="novel-author-mobile" class="text-xs text-gray-700 dark:text-gray-300 md:hidden"></p>
            </div>
        </div>
    </div>

    <div id="age-gate-view" class="view active fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 text-center max-w-sm w-full">
            <h2 id="age-gate-title" class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4">å¹´é½¡ç¢ºèª</h2>
            <p id="age-gate-message" class="text-gray-600 dark:text-gray-400 mb-8">æœ¬ç¶²ç«™å…§å®¹å¯èƒ½ä¸é©åˆæœªæ»¿18æ­²çš„ä½¿ç”¨è€…ï¼Œ<br>æ‚¨æ˜¯å¦å·²å¹´æ»¿18æ­²ï¼Ÿ</p>
            <div id="age-gate-buttons" class="flex justify-center gap-4">
                <button id="btnYes" class="bg-violet-600 hover:bg-violet-700 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105">æ˜¯ï¼Œæˆ‘å·²æ»¿18æ­²</button>
                <button id="btnNo" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105">å¦</button>
            </div>
        </div>
    </div>

    <div id="book-list-view" class="view container mx-auto p-4 sm:p-6 md:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-violet-600 dark:text-violet-400">ç·šä¸Šæ›¸åº«</h1>
            <p class="mt-4 text-lg text-gray-700 dark:text-gray-300">ä½œè€…ï¼šæ³•å¼è‰è“å¸ƒä¸</p>
        </header>
        <main id="book-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <p id="loading-books-text" class="text-gray-500 col-span-full text-center">æ­£åœ¨è¼‰å…¥æ›¸åº«...</p>
        </main>
    </div>

    <div id="novel-view" class="view container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl"> 
        <main class="content-area bg-white dark:bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg flex flex-col h-full scrollable-content"> 
            <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">ç« ç¯€å…§å®¹</h2>
            <div id="content-title" class="mt-2 mb-2 text-2xl font-bold text-gray-800 dark:text-gray-200"></div>
            <p id="content-note" class="mt-1 text-sm text-gray-500 dark:text-gray-400"></p>
            <div id="content-body" class="leading-relaxed flex-grow"><p class="text-gray-500">è«‹å¾ä¸Šæ–¹é¸æ“‡ä¸€å€‹ç« ç¯€ã€‚</p></div> 

            <div class="mt-4 text-center text-xs text-gray-400 dark:text-gray-500 pb-2 flex-shrink-0">
                <p>&copy; 2025. All rights reserved.</p>
            </div>
        </main>
    </div>

<script>
    // --- å…¨åŸŸè®Šæ•¸å’Œ DOM å…ƒç´  ---
    let allNovels = [];
    let views = {}; // å…ˆå®šç¾©ç‚ºç©ºç‰©ä»¶
    let chapterSelect; // å…ˆå®šç¾©ç‚ºç©ºè®Šæ•¸
    let fixedHeaderBar; // å…ˆå®šç¾©ç‚ºç©ºè®Šæ•¸

    // --- æ ¸å¿ƒé‚è¼¯ ---
    document.addEventListener('DOMContentLoaded', () => {
        // åœ¨ DOMContentLoaded å…§éƒ¨ç²å–æ‰€æœ‰ DOM å…ƒç´ 
        views = {
            ageGate: document.getElementById('age-gate-view'),
            bookList: document.getElementById('book-list-view'),
            novel: document.getElementById('novel-view')
        };
        chapterSelect = document.getElementById('chapter-select');
        fixedHeaderBar = document.getElementById('fixed-header-bar');

        // åˆå§‹éš±è—å›ºå®šé ‚éƒ¨æ¬„ (ç¢ºä¿å…ƒç´ å·²ç¶“è¢«ç²å–)
        if (fixedHeaderBar) { // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ 
            fixedHeaderBar.style.display = 'none';
        }

        // æª¢æŸ¥ sessionStorage æ˜¯å¦æœ‰å¹´é½¡é©—è­‰ç‹€æ…‹
        if (sessionStorage.getItem('isAgeVerified') === 'true') {
            showView('bookList');
            loadLibrary();
        } else {
            showView('ageGate'); // å¦‚æœæœªé©—è­‰ï¼Œé¡¯ç¤ºå¹´é½¡é©—è­‰é é¢
        }
        
        // ç¶å®šå¹´é½¡é©—è­‰æŒ‰éˆ•çš„äº‹ä»¶ç›£è½å™¨
        const btnYes = document.getElementById('btnYes');
        const btnNo = document.getElementById('btnNo');
        if (btnYes) btnYes.addEventListener('click', handleAgeGateYes);
        if (btnNo) btnNo.addEventListener('click', handleAgeGateNo);


        document.getElementById('back-to-library').addEventListener('click', () => showView('bookList'));
        
        // æ–°å¢ç« ç¯€é¸å–®çš„äº‹ä»¶ç›£è½å™¨
        if (chapterSelect) { // æª¢æŸ¥ chapterSelect æ˜¯å¦å­˜åœ¨
            chapterSelect.addEventListener('change', (event) => {
                const selectedIndex = event.target.value;
                if (selectedIndex !== "") { // ç¢ºä¿ä¸æ˜¯é è¨­çš„ç©ºé¸é …
                    // åœ¨æ­¤è™•éœ€è¦æ‰¾åˆ°ç•¶å‰é¡¯ç¤ºçš„å°èªªæ•¸æ“š
                    const currentNovelTitle = document.getElementById('novel-title').textContent;
                    const currentNovel = allNovels.find(n => n.title === currentNovelTitle);
                    
                    if (currentNovel && currentNovel.chapters[selectedIndex]) {
                        const chapter = currentNovel.chapters[selectedIndex];
                        loadChapterContent(currentNovel.folder, chapter.file, chapter.title, chapter.note);
                    }
                }
            });
        }
    });

    // --- è¦–åœ–ç®¡ç† ---
    function showView(viewName) {
        Object.values(views).forEach(view => {
            view.classList.remove('active');
        });
        if (views[viewName]) {
            views[viewName].classList.add('active');
        }

        // æ ¹æ“šè¦–åœ–é¡¯ç¤ºæˆ–éš±è—å›ºå®šé ‚éƒ¨æ¬„
        if (fixedHeaderBar) { // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ 
            if (viewName === 'novel') {
                fixedHeaderBar.style.display = 'block';
            } else {
                fixedHeaderBar.style.display = 'none';
            }
        }
    }

    // --- å¹´é½¡é©—è­‰çš„äº‹ä»¶è™•ç†å‡½å¼ ---
    function handleAgeGateYes() {
        sessionStorage.setItem('isAgeVerified', 'true');
        showView('bookList');
        loadLibrary();
    }

    function handleAgeGateNo() {
        const ageGateView = views.ageGate;
        ageGateView.querySelector('#age-gate-title').textContent = "å­˜å–é™åˆ¶";
        ageGateView.querySelector('#age-gate-message').innerHTML = "æŠ±æ­‰ï¼Œæ‚¨å¿…é ˆå¹´æ»¿18æ­²æ‰èƒ½ç€è¦½æœ¬ç¶²ç«™ã€‚";
        ageGateView.querySelector('#age-gate-buttons').style.display = 'none';
    }

    // --- è³‡æ–™è¼‰å…¥èˆ‡æ¸²æŸ“ ---
    async function loadLibrary() {
        const bookListContainer = document.getElementById('book-list');
        const loadingText = document.getElementById('loading-books-text');
        
        if (allNovels.length > 0) {
            loadingText.style.display = 'none';
            return;
        }

        loadingText.textContent = "æ­£åœ¨è¼‰å…¥æ›¸åº«...";
        loadingText.className = 'text-gray-500 col-span-full text-center';

        try {
            const response = await fetch('filelist.json');
            
            if (!response.ok) {
                throw new Error(`ç„¡æ³•è¼‰å…¥ filelist.json: ç‹€æ…‹ç¢¼ ${response.status}`);
            }

            const data = await response.json();

            if (!Array.isArray(data) || data.length === 0) {
                bookListContainer.innerHTML = '<p class="text-red-500 col-span-full text-center">`filelist.json` æ˜¯ç©ºçš„æˆ–æ ¼å¼éŒ¯èª¤ã€‚</p>';
                loadingText.style.display = 'none';
                return;
            }

            allNovels = data;

            loadingText.style.display = 'none';
            bookListContainer.innerHTML = '';

            allNovels.forEach(novel => {
                if (!novel.title || !novel.author || !Array.isArray(novel.chapters)) {
                    console.warn('åµæ¸¬åˆ°ä¸å®Œæ•´çš„å°èªªè³‡æ–™:', novel);
                    return;
                }

                const card = document.createElement('div');
                card.className = "bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 cursor-pointer";
                card.innerHTML = `<h2 class="text-xl font-bold text-violet-700 dark:text-violet-400">${novel.title}</h2><p class="mt-2 text-gray-600 dark:text-gray-400">ä½œè€…ï¼š${novel.author}</p><p class="mt-4 text-sm text-gray-500 dark:text-gray-500">å…± ${novel.chapters.length} ç« </p>`;
                card.addEventListener('click', () => renderNovelView(novel));
                bookListContainer.appendChild(card);
            });
        } catch (error) {
            console.error('è¼‰å…¥æ›¸åº«å¤±æ•—:', error);
            loadingText.textContent = `è¼‰å…¥æ›¸åº«å¤±æ•—: ${error.message}`;
            loadingText.className = 'text-red-500 col-span-full text-center';
            bookListContainer.innerHTML = '';
        }
    }

    function renderNovelView(novel) {
        document.getElementById('novel-title').textContent = novel.title;
        document.getElementById('novel-author').textContent = `ä½œè€…ï¼š${novel.author}`;
        document.getElementById('novel-author-mobile').textContent = `ä½œè€…ï¼š${novel.author}`;

        // æ¸…ç©ºèˆŠé¸é …ï¼Œä¸¦æ·»åŠ é è¨­é¸é …
        chapterSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç« ç¯€</option>';
        novel.chapters.forEach((chapter, index) => {
            const option = document.createElement('option');
            option.value = index; // ä½¿ç”¨ç´¢å¼•ä½œç‚ºå€¼
            option.textContent = chapter.title;
            chapterSelect.appendChild(option);
        });

        // é‡ç½®é¸å–®é¸æ“‡ç‚ºé è¨­å€¼
        chapterSelect.value = "";

        // æ¸…ç©ºå…§å®¹ï¼Œç­‰å¾…ç”¨æˆ¶é¸æ“‡ç« ç¯€
        document.getElementById('content-title').textContent = '';
        document.getElementById('content-body').innerHTML = '<p class="text-gray-500">è«‹å¾ä¸Šæ–¹é¸æ“‡ä¸€å€‹ç« ç¯€ã€‚</p>';
        document.getElementById('content-note').textContent = '';
        showView('novel');
    }

    async function loadChapterContent(folder, filename, displayTitle, note) {
        const contentTitle = document.getElementById('content-title');
        const contentBody = document.getElementById('content-body');
        const contentNote = document.getElementById('content-note');
        
        // é€™è£¡ä¸å†æ¸…ç©º contentTitleï¼Œè®“å®ƒæ­£å¸¸é¡¯ç¤ºç« ç¯€åç¨±
        contentTitle.textContent = displayTitle;
        contentTitle.style.display = 'block';

        if (note) {
            contentNote.textContent = `ğŸ“ ${note}`;
            contentNote.style.display = 'block';
        } else {
            contentNote.textContent = '';
            contentNote.style.display = 'none';
        }
        contentBody.innerHTML = `<p class="text-gray-500">æ­£åœ¨è¼‰å…¥ç« ç¯€...</p>`;
        
        try {
            // æ³¨æ„ï¼šé€™è£¡å‡è¨­ filelist.json ä¸­çš„ filename å·²ç¶“æ˜¯ .md çµå°¾
            // å¦‚æœ filelist.json ä¸­çš„ filename é‚„æ˜¯ .txtï¼Œéœ€è¦èª¿æ•´ç‚º filename.replace('.txt', '.md')
            const response = await fetch(`novels/${encodeURIComponent(folder)}/${encodeURIComponent(filename)}`);
            if (!response.ok) throw new Error(`æª”æ¡ˆè®€å–å¤±æ•— (${response.status})`);
            
            let markdownContent = await response.text(); 
            
            // æª¢æŸ¥ markdownContent æ˜¯å¦æœ‰å…§å®¹ï¼Œç„¶å¾Œç§»é™¤ç¬¬ä¸€è¡Œ
            const lines = markdownContent.split('\n');
            if (lines.length > 1) {
                markdownContent = lines.slice(1).join('\n');
            } else {
                markdownContent = '';
            }

            // å°‡ Markdown è½‰æ›ç‚º HTML
            const htmlContent = marked.parse(markdownContent); //
            
            contentBody.innerHTML = htmlContent; 
        } catch (error) {
            contentBody.innerHTML = `<p class="text-red-500">è¼‰å…¥ç« ç¯€æ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}</p>`;
        }
    }
</script>
</body>
</html>
